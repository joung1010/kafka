## 프로듀서
카프카에서 **데이터의 시작점**은 프로듀서이다.  
  
애플리케이션은 카프카에 필요한 데이터를 선언하고 브로커의 특정 토픽의 파티션에 전송한다. 프로듀서는 데이터를 전송할 때 리더 파티션을 가지고 있는 카프카 브로커와 직접 통신한다.  
  
카프카 브로커로 데이터를 전손할 때 내부적으로 파티셔너, 배치 새성 단계를 거친다.

## 프로듀서 동작 흐름도

```

┌─────────────────────────────────────────────────────────────────────────┐
│                          프로듀서 애플리케이션                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐                                                       │
│  │   비즈니스   │  send(ProducerRecord)                                 │
│  │    로직     │ ──────────────────┐                                   │
│  └─────────────┘                   ▼                                   │
│                          ┌─────────────────────┐                       │
│                          │   ProducerRecord    │                       │
│                          │  ┌───────────────┐  │                       │
│                          │  │ Topic: orders │  │                       │
│                          │  │ Key: user123  │  │                       │
│                          │  │ Value: {...}  │  │                       │
│                          │  │ Headers: []   │  │                       │
│                          │  └───────────────┘  │                       │
│                          └──────────┬──────────┘                       │
│                                     ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         Interceptors                             │   │
│  │                    (메시지 변환/모니터링)                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                     ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         Serializer                               │   │
│  │  ┌─────────────────┐       ┌─────────────────┐                 │   │
│  │  │ Key Serializer  │       │ Value Serializer │                 │   │
│  │  │ String → byte[] │       │ JSON → byte[]    │                 │   │
│  │  └─────────────────┘       └─────────────────┘                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                     ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         Partitioner                              │   │
│  │                                                                  │   │
│  │   Key가 있는 경우:  hash(key) % partition_count                 │   │
│  │   Key가 없는 경우:  Round-Robin or Sticky Partitioner           │   │
│  │                                                                  │   │
│  │   결정된 파티션: Partition 2                                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                     ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Record Accumulator                            │   │
│  │                    (레코드 누적기)                               │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │   │
│  │  │ Partition 0  │  │ Partition 1  │  │ Partition 2  │         │   │
│  │  │ ┌──────────┐ │  │ ┌──────────┐ │  │ ┌──────────┐ │         │   │
│  │  │ │  Batch 1 │ │  │ │  Batch 1 │ │  │ │  Batch 1 │ │ ◄─┐     │   │
│  │  │ │ [R1,R2]  │ │  │ │ [R5,R6]  │ │  │ │ [R3,R4]  │ │   │     │   │
│  │  │ └──────────┘ │  │ └──────────┘ │  │ └──────────┘ │   │     │   │
│  │  │ ┌──────────┐ │  │ ┌──────────┐ │  │ ┌──────────┐ │   │     │   │
│  │  │ │  Batch 2 │ │  │ │  Batch 2 │ │  │ │  Batch 2 │ │   │     │   │
│  │  │ │   [R7]   │ │  │ │    []    │ │  │ │ [R8,R9]  │ │   │     │   │
│  │  │ └──────────┘ │  │ └──────────┘ │  │ └──────────┘ │   │     │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘         │   │
│  │                                                                  │   │
│  │  설정값:                                                         │   │
│  │  - batch.size: 16KB (배치 최대 크기)                           │   │
│  │  - linger.ms: 10ms (배치 대기 시간)                            │   │
│  │  - buffer.memory: 32MB (전체 버퍼 크기)                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                     ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      Sender Thread                               │   │
│  │                   (네트워크 I/O 스레드)                         │   │
│  │                                                                  │   │
│  │  1. 배치가 꽉 차거나 linger.ms 시간이 지나면 전송 준비         │   │
│  │  2. 브로커별로 요청을 그룹화                                   │   │
│  │  3. 압축 알고리즘 적용 (설정된 경우)                           │   │
│  │  4. 네트워크를 통해 브로커로 전송                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            카프카 클러스터                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │
│  │   Broker 0      │  │   Broker 1      │  │   Broker 2      │        │
│  │                 │  │                 │  │                 │        │
│  │  ┌───────────┐  │  │  ┌───────────┐  │  │  ┌───────────┐  │        │
│  │  │Partition 0│  │  │  │Partition 1│  │  │  │Partition 2│  │        │
│  │  │ (Leader)  │  │  │  │ (Leader)  │  │  │  │ (Leader)  │  │ ◄──┐   │
│  │  └───────────┘  │  │  └───────────┘  │  │  └───────────┘  │    │   │
│  │  ┌───────────┐  │  │  ┌───────────┐  │  │  ┌───────────┐  │    │   │
│  │  │Partition 1│  │  │  │Partition 2│  │  │  │Partition 0│  │    │   │
│  │  │ (Follower)│  │  │  │ (Follower)│  │  │  │ (Follower)│  │    │   │
│  │  └───────────┘  │  │  └───────────┘  │  │  └───────────┘  │    │   │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘        │
│                                                                         │
│  프로듀서는 리더 파티션과만 직접 통신                                  │
└─────────────────────────────────────────────────────────────────────────┘

```
  
## 프로두서 내부 구조(자바 라이브러리 기준)

### 1. ProducerRecord

프로듀서가 전송하는 데이터의 기본 단위입니다.(오프셋 미포함)

오프셋은 이 레코드가 특정 파티션에 지정되어 저장되고 나서 지정된다.

- **Topic**: 메시지가 전송될 토픽
- **Partition**: (선택) 특정 파티션 지정
- **Key**: (선택) 파티셔닝에 사용되는 키
- **Value**: 실제 메시지 내용
- **Headers**: (선택) 메타데이터

### 2. Send

레코드 전송 요청 메서드

### 3. Partitioner

레코드를 어느 파티션으로 전송할지 결정합니다. 기본 값은 **DefaultPartitioner로** 설정된다.

- **DefaultPartitioner**: 키가 있으면 해시 기반, 없으면 라운드 로빈
- **RoundRobinPartitioner**: 순차적으로 파티션 할당
- **UniformStickyPartitioner**: 배치 효율성을 위해 일정 시간 동안 같은 파티션 사용

### 4. Record Accumulator

배치로 묶어 전송할 데이터를 모으는 버

- 전송 전 레코드를 배치로 묶어 관리
- 파티션별로 배치 큐 유지
- 네트워크 효율성과 처리량 향상